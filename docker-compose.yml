# Pure local development environment

version: '2'
services:

  swag:
    image: ghcr.io/linuxserver/swag
    container_name: swag
    cap_add:
      - NET_ADMIN
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - ONLY_SUBDOMAINS=true
      - URL=airsports.no
      - SUBDOMAINS=tracking,traccar
      - EMAIL=frankose@ifi.uio.no
      - VALIDATION=http
    volumes:
      - ./swag/config:/config
      - ./assets:/assets/
      - ./static:/static
    ports:
      - 443:443
      - 80:80 # Required for certificate validation
    restart: unless-stopped

  tracker_web:
    #    command: [ "bash", "-c", "python3 manage.py migrate && cd / && (npm run webpack-local &) && cd /src && python3 manage.py initadmin && python3 manage.py createdefaultscores && python3 manage.py runserver 0.0.0.0:8000" ]
    command: [ "/wait-for-it.sh", "mysql:3306", "--",
               "/wait-for-it.sh", "influx:8086", "--",
#               "bash", "-c", "python3 manage.py migrate && cd / && (npm run webpack-local &) && cd /src && python3 manage.py initadmin && python3 manage.py createdefaultscores && python3 manage.py runserver 0.0.0.0:8002" ]
                "bash", "-c", "python3 manage.py migrate && cd / && npm run webpack && cd /src && python3 manage.py initadmin && python3 manage.py createdefaultscores && redis-cli -h redis -p 6381 FLUSHALL && python3 manage.py collectstatic --noinput && bash -c /gunicorn.sh" ]

    container_name: tracker_web
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./static:/static
      - ./assets:/assets/
      - ./src:/src/
      - ./reactjs:/reactjs/
      - ./data:/data/
    ports:
      - "8002:8000"
    depends_on:
      - mysql
      - influx
      - redis

  tracker_processor:
    command: [ "/wait-for-it.sh", "mysql:3306", "--",
               "/wait-for-it.sh", "traccar:8082", "--",
               "/wait-for-it.sh", "influx:8086", "--",
               "bash", "-c", "python3 position_processor.py" ]
    container_name: tracker_processor
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./src:/src/
    depends_on:
      - influx
      - traccar
      - mysql
      - redis

  influx:
    image: influxdb
    restart: always
    volumes:
      - influxdb:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=airsport
      - INFLUXDB_USER=airsport
      - INFLUXDB_USER_PASSWORD=notsecret
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"

  traccar:
    image: traccar/traccar
    restart: unless-stopped
    container_name: traccar
    volumes:
      - traccar-db:/opt/traccar/data/database
      - ./traccar/configuration/traccar.xml:/opt/traccar/conf/traccar.xml
    ports:
      - 5000-5150:5000-5150
      - 5000-5150:5000-5150/udp
      - 8082:8082
    depends_on:
      - mysql

  mysql:
    image: mysql
    container_name: mysql
    restart: always
    environment:
      #      - MYSQL_DATABASE=traccar
      #      - MYSQL_USER=traccar
      - MYSQL_ROOT_PASSWORD=traccar
    #      - MYSQL_PASSWORD=traccar
    volumes:
      - mysqldata:/var/lib/mysql/
      - ./traccar/configuration/mysql.sql:/docker-entrypoint-initdb.d/mysql.sql

  redis:
    image: redis
    container_name: redis


volumes:
  influxdb:
  mysqldata:
  traccar-db: