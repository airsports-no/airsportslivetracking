{% extends "base.html" %}
{% load static %}
{% load bootstrap4 %}
{% load crispy_forms_tags %}
{% block content %}
    {% if object %}
        <h2>Update Contestant {{ object }} for navigation task {{ object.navigation_task }}</h2>
    {% else %}
        <h2>Create new Contestant for navigation task {{ navigation_task }} </h2>
    {% endif %}
    {{ form.media }}
    Contest time zone is {{ navigation_task.contest.time_zone }}
    <form method="post" class="form">
        {% csrf_token %}
        {% crispy form %}
    </form>
    <script type="text/javascript">
        Date.prototype.addHours = function(h) {
            this.setTime(this.getTime() + (h*60*60*1000));
            return this;
          }
        Date.prototype.toMyString = function() {
            return this.format("yyyy-mm-dd HH:MM")
        }

          
        const adaptiveStart = document.getElementById("id_adaptive_start");
        const takeoffTime = document.getElementById("id_takeoff_time");
        const trackingStart = document.getElementById("id_tracker_start_time");
        const finishedByTime=document.getElementById('id_finished_by_time')
        const teamSelector=document.getElementById("id_team")

        

        function updateTracking() {
            trackingStart.value = new Date(Date.parse(takeoffTime.value)).addHours(-0.16666667).toMyString()
            let hours=2
            if (adaptiveStart.checked) {
                hours=5
            }
            finishedByTime.value=new Date(Date.parse(takeoffTime.value)).addHours(hours).toMyString()
        }

        $("#id_takeoff_time").datetimepicker({dateFormat: "yy-mm-dd", onSelect: updateTracking});
        $("#id_finished_by_time").datetimepicker({dateFormat: "yy-mm-dd"});
        $("#id_tracking_start").datetimepicker({dateFormat: "yy-mm-dd"});
        takeoffTime.addEventListener("change",(event)=>{updateTracking()})
       
        adaptiveStart.addEventListener("change", (event) => {
            trackingStart.readOnly = adaptiveStart.checked;
            updateTracking()
        })

        async function updateAirspeed(event){
            const selectedTeam=teamSelector.value
            const response=await fetch("/api/v1/contests/"+{{ navigation_task.contest.id }}+"/contest_team_for_team/"+selectedTeam+"/",{method: "GET"})
            if(response.ok){
                const data=await response.json()
                document.getElementById("id_air_speed").value=data.air_speed
            }
        }

        teamSelector.addEventListener("change",updateAirspeed)

        {% if object.adaptive_start %}
            trackingStart.readOnly = adaptiveStart.checked;
        {% endif %}
    </script>
{% endblock %}
