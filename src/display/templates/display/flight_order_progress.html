{% extends "base.html" %}
{% load static %}
{% block content %}
    <h5> Generating flight order for</h5>
    <p>
        {% if single_contestant %}
            <h2>Contestant {{ single_contestant }}</h2>
        {% else %}
            <H2>Navigation task {{ navigation_task }}</H2>
        {% endif %}
    </p>

    <p>
        <a class="btn btn-primary" href="{% url 'navigationtask_detail' navigation_task.pk %}">Back</a>
        <button class="btn btn-danger" onclick="generateFlightOrders()" id="generate_button">(Re)Generate flight orders
        </button>
    </p>
    <p class="text-muted">Flight orders can only be generated for contestants with takeoff times in the future. If the
        table below is empty it means that there are no contestants that match this and you need to update them.
        Generation can take a few minutes per contestant, so please be patient. Progress and any failures
        will continuously
        be reported in the table below.</p>
    <div id="loading" style="display: none">
        <img class="center" src="/static/img/loading_airplane.gif" alt="loading..."/>
    </div>
    <table class="table">
        <thead>
        <tr>
            <th>Contestant</th>
            <th>Previously generated</th>
            <th>Generating</th>
            <th>Sending</th>
            <th>Errors</th>
        </tr>
        </thead>
        {% for contestant in contestants %}
            <tr>
                <td>{{ contestant }}</td>
                <td>{% if contestant.has_flight_order_link %}<img src="{% static '/img/green_checkmark.png' %}"  style="width: 24px"/>{% endif %}</td>
                <td id="generating_{{ contestant.pk }}"></td>
                <td id="transmitting_{{ contestant.pk }}"></td>
                <td id="errors_{{ contestant.pk }}"></td>
            </tr>
        {% endfor %}
    </table>
    <div id="details"></div>
    <div id="successful_menu" style="display: none">
        {% if single_contestant %}
            <a class="btn btn-primary"
               href="{% url 'navigationtask_broadcastflightorders' navigation_task.pk %}?contestant_pk={{ single_contestant.pk }}"
               role="button">Broadcast</a>
            <a class="btn btn-primary"
               href="{% url 'navigationtask_downloadflightorders' navigation_task.pk %}?contestant_pk={{ single_contestant.pk }}"
               role="button">Download</a>
        {% else %}
            <button class="btn btn-primary" onclick="broadcastFlightOrders()"
                    role="button">Broadcast
            </button>
            <a class="btn btn-primary" href="{% url 'navigationtask_downloadflightorders' navigation_task.pk %}"
               role="button">Download</a>
        {% endif %}
    </div>
    <script type="text/javascript">
        var generating = false
        var first = true

        function clearStatus() {
            for (var key of {{ contestant_pks }}) {
                document.getElementById("generating_" + key).innerHTML = ""
                document.getElementById("transmitting_" + key).innerHTML = ""
                document.getElementById("errors_" + key).innerHTML = ""
            }
        }

        function disableGenerate() {
            document.getElementById("generate_button").disabled = true
        }

        function enableGenerate() {
            document.getElementById("generate_button").disabled = false
        }

        function generateFlightOrders() {
            document.getElementById("loading").removeAttribute("style")
            document.getElementById("successful_menu").setAttribute("style", "display: none")
            disableGenerate()
            clearStatus()
            generating = true
            $.ajax({
                url: "/display/navigationtask/{{ navigation_task.pk }}/generateflightorders/?contestant_pks={{ contestant_pks|join:"," }}",
                type: 'get',
                dataType: "json",
                success: function (data) {
                    updateRunningStatus(data)
                }
            });
        }

        function broadcastFlightOrders() {
            $.ajax({
                url: "/display/navigationtask/{{ navigation_task.pk }}/broadcastflightorders/?contestant_pks={{ contestant_pks|join:"," }}",
                type: 'get',
                dataType: "json",
                success: function (data) {
                    updateRunningStatus(data)
                }
            });
        }

        function redirect() {
            location.href = "{% url 'navigationtask_detail' navigation_task.pk %}"
        }

        function updateRunningStatus(data) {
            var ongoing = new Set()
            if (data.completed_flight_orders_map) {
                completed = true
                for (const [key, value] of Object.entries(data.completed_flight_orders_map)) {
                    if (!value) {
                        ongoing.add(key)
                        document.getElementById("generating_" + key).innerHTML = '<img src="{% static '/img/loading.gif' %}" style="width: 24px"/>'
                    } else {
                        document.getElementById("generating_" + key).innerHTML = '<img src="{% static '/img/green_checkmark.png' %}"  style="width: 24px"/>'

                    }
                }
            }
            if (data.transmitted_flight_orders_map) {
                for (const [key, value] of Object.entries(data.transmitted_flight_orders_map)) {
                    if (!value) {
                        document.getElementById("transmitting_" + key).innerHTML = '<img src="{% static '/img/loading.gif' %}"  style="width: 24px"/>'
                    } else {
                        document.getElementById("transmitting_" + key).innerHTML = '<img src="{% static '/img/green_checkmark.png' %}"  style="width: 24px"/>'

                    }
                }
            }
            if (data.generate_failed_flight_orders_map) {
                for (const [key, value] of Object.entries(data.generate_failed_flight_orders_map)) {
                    ongoing.delete(key)
                    document.getElementById("errors_" + key).innerHTML = value
                    document.getElementById("generating_" + key).innerHTML = '<img src="{% static '/img/red_cross.png' %}"  style="width: 24px"/>'
                }
            }
            if (data.transmit_failed_flight_orders_map) {
                for (const [key, value] of Object.entries(data.transmit_failed_flight_orders_map)) {
                    document.getElementById("errors_" + key).innerHTML = value
                    document.getElementById("transmitting_" + key).innerHTML = '<img src="{% static '/img/red_cross.png' %}"  style="width: 24px"/>'
                }
            }
            if (first && generating) {
                document.getElementById("loading").removeAttribute("style")
                disableGenerate()
            }
            if (ongoing.size === 0 && (generating || first)) {
                generating = false
                enableGenerate()
                document.getElementById("loading").setAttribute("style", "display: none")
                document.getElementById("successful_menu").removeAttribute("style")
                {#setTimeout(redirect, 10000)#}
            }
            first = false
        }

        function getFlightOrderProgress() {
            $.ajax({
                url: "/display/navigationtask/{{ navigation_task.pk }}/getflightordersstatus/",
                type: 'get',
                dataType: "json",
                success: function (data) {
                    updateRunningStatus(data);
                }
            });
        }

        $(document).ready(function () {
            getFlightOrderProgress()
            setInterval(getFlightOrderProgress, 5000);


        })

    </script>
{% endblock %}